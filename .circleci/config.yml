version: 2.1

jobs:
  build_n_test:
    description: 'Build & Test'

    docker: # See ../circleci.dockerfile
    - image: cchantep/reactivemongo:1.0.0-c7c6ebf-SNAPSHOT

    working_directory: ~/repo

    environment:
      CIRCLE_ARTIFACTS: /tmp/circleci-artifacts
      CIRCLE_TEST_REPORTS: /tmp/circleci-test-results

    steps:
      - checkout

      # Validate site
      - run:
          name: Prepare build checksum
          command: |
                    find . -not -path '*/_site/*' -name '*.sbt' -type f \
                      -exec cat {} \; > /tmp/build

      - restore_cache:
          keys:
            - &build_cache_key sbt-{{ checksum "/tmp/build" }}
            - &branch_cache_key dep-{{ .Branch }}

      - run:
          name: Prepare artifact directories
          command: mkdir -p $CIRCLE_ARTIFACTS $CIRCLE_TEST_REPORTS

      - run:
          name: 'Build & validate'
          command: |
                    ln -s /node_modules node_modules
                    java -version && ./.ci_scripts/validate.sh 1.3.13

      - run:
          name: Run Jekyll in background
          background: true
          command: |
                    on_term() {
                      echo "Terminated"
                      exit 0
                    }

                    trap on_term SIGTERM

                    bundle exec jekyll serve

      - save_cache:
          key: *branch_cache_key
          paths:
            - ~/repo/node_modules

      - save_cache:
          key: *build_cache_key
          paths:
            - ~/.m2
            - ~/.ivy2
            - ~/.sbt
            - ~/.coursier/cache

      - run:
          name: Check Jekyll site
          command: ./.ci_scripts/consolidate.sh

  algolia:
    description: 'Index to Algolia'

    docker:
    - image: cchantep/reactivemongo:1.0.0-c7c6ebf-SNAPSHOT

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Indexing to Algolia
          command: |
                    test "x$CIRCLE_BRANCH" = "xgh-pages" && \
                    bundle exec jekyll algolia || \
                    echo "Skip on branch $CIRCLE_BRANCH"

workflows:
  version: 2

  main_suite:
    jobs:
      - build_n_test

      - algolia:
          filters:
            branches:
              only:
                - gh-pages
          requires:
            - build_n_test
